# PostgreSQL Support Analysis for SQL-SOAR

## Project Overview

**SQL-SOAR** (Simple Object Adapter for Relational database) is a lightweight Node.js module designed to simplify SQL operations without the complexity of full ORM solutions. Currently, it only supports MySQL databases.

### Key Features
- Reusable SQL expressions as JSON objects
- Simple query interface with automatic WHERE clause generation
- Multiple database connection support
- Schema manipulation capabilities
- Full developer control over SQL generation
- Extremely lightweight and efficient

## Current Architecture Analysis

### Core Components

1. **Main Entry Point** (`lib/soar.js`)
   - Exports public API functions (query, list, insert, update, delete)
   - Handles command transformation and parameter processing
   - Delegates to sqlEngine for execution

2. **SQL Engine** (`lib/core/sqlEngine.js`)
   - Coordinates SQL execution
   - Currently hardcoded to use MySQL SQL generator
   - Handles stored expressions and formula loading

3. **Database Management** (`lib/core/DBManager.js`)
   - Manages database connections and configuration
   - Creates DBConn instances for each configured database
   - Loads stored SQL expressions

4. **Database Connection** (`lib/core/DBConn.js`)
   - Hardcoded to use MySQL driver (`mysql` package)
   - Manages connection pooling
   - Caches table schemas and stored formulas

5. **SQL Generation** (`lib/sql/sqlGenMySql.js`)
   - MySQL-specific SQL statement generation
   - Handles CREATE/ALTER/DROP table operations
   - Generates SELECT, INSERT, UPDATE, DELETE statements
   - Contains MySQL-specific syntax and functions

6. **Schema Management** (`lib/schemaManager.js`)
   - Uses MySQL-specific SHOW commands
   - Hardcoded MySQL system queries for metadata

### MySQL-Specific Dependencies

1. **NPM Package**: `mysql@^2.18.1`
2. **SQL Syntax**: MySQL-specific features used throughout
3. **Schema Queries**: SHOW COLUMNS, SHOW INDEX, SHOW TABLE STATUS
4. **SQL Functions**: FOUND_ROWS(), SQL_CALC_FOUND_ROWS
5. **Backtick Quoting**: Uses MySQL's `` ` `` for identifier quoting

## PostgreSQL Integration Requirements

### High Priority Changes

1. **SQL Generator** (`lib/sql/sqlGenPostgreSQL.js`)
   - Create PostgreSQL-specific SQL generation
   - Key differences from MySQL:
     - Use double quotes (`"`) for identifiers instead of backticks
     - Different data types (e.g., `SERIAL` vs `AUTO_INCREMENT`)
     - Different pagination (`LIMIT x OFFSET y` vs `LIMIT y, x`)
     - No `FOUND_ROWS()` - use `COUNT(*) OVER()`
     - Different table creation syntax for constraints

2. **Database Connection** (`lib/core/DBConnPostgreSQL.js`)
   - New connection class using `pg` package
   - Connection pooling adaptation
   - Error handling differences

3. **Database Manager Updates** (`lib/core/DBManager.js`)
   - Database type detection from configuration
   - Route to appropriate connection class
   - Support both MySQL and PostgreSQL simultaneously

4. **SQL Engine Updates** (`lib/core/sqlEngine.js`)
   - Dynamic SQL generator selection based on database type
   - Support multiple database types in same application

5. **Schema Manager Updates** (`lib/schemaManager.js`)
   - PostgreSQL information schema queries
   - Replace SHOW commands with standard SQL queries
   - Handle PostgreSQL-specific metadata format

### Medium Priority Changes

6. **Package Dependencies**
   - Add `pg` package for PostgreSQL support
   - Update package.json with optional peer dependency

7. **Configuration Updates**
   - Add database type detection in config
   - Support PostgreSQL connection parameters

### Low Priority Changes

8. **Testing Infrastructure**
   - Create PostgreSQL test configurations
   - Adapt existing tests for multi-database support

9. **Documentation Updates**
   - Configuration examples for PostgreSQL
   - Migration guide from MySQL-only to multi-database

## Key Differences: MySQL vs PostgreSQL

### SQL Syntax Differences

| Feature | MySQL | PostgreSQL |
|---------|-------|------------|
| Identifier Quoting | `` `column` `` | `"column"` |
| Auto Increment | `AUTO_INCREMENT` | `SERIAL` or `GENERATED BY DEFAULT AS IDENTITY` |
| Pagination | `LIMIT offset, count` | `LIMIT count OFFSET offset` |
| Row Count | `SQL_CALC_FOUND_ROWS` + `FOUND_ROWS()` | `COUNT(*) OVER()` window function |
| Case Sensitivity | Case insensitive | Case sensitive (when quoted) |
| Boolean Type | `TINYINT(1)` | `BOOLEAN` |

### Schema Information Queries

| Operation | MySQL | PostgreSQL |
|-----------|-------|------------|
| Column Info | `SHOW COLUMNS FROM table` | `SELECT * FROM information_schema.columns WHERE table_name = 'table'` |
| Primary Keys | `SHOW INDEX FROM table WHERE Key_name='PRIMARY'` | `SELECT * FROM information_schema.key_column_usage WHERE table_name = 'table'` |
| Table Status | `SHOW TABLE STATUS WHERE name='table'` | `SELECT * FROM information_schema.tables WHERE table_name = 'table'` |

### Connection Parameters

| Parameter | MySQL | PostgreSQL |
|-----------|-------|------------|
| Driver Package | `mysql` | `pg` |
| Host | `host` | `host` |
| Port | `port` (default 3306) | `port` (default 5432) |
| Database | `database` | `database` |
| User | `user` | `user` |
| Password | `password` | `password` |
| SSL | `ssl` | `ssl` |

## Implementation Strategy

### Phase 1: Core Infrastructure
1. Create PostgreSQL SQL generator
2. Create PostgreSQL connection class
3. Update database manager for type detection
4. Update SQL engine for dynamic generator selection

### Phase 2: Schema Support
1. Implement PostgreSQL schema operations
2. Update schema manager with information_schema queries
3. Handle PostgreSQL-specific data type mappings

### Phase 3: Testing & Documentation
1. Create test configurations for PostgreSQL
2. Adapt existing tests for multi-database scenarios
3. Update documentation with PostgreSQL examples

## Backward Compatibility

The implementation will maintain 100% backward compatibility:
- Existing MySQL configurations continue to work unchanged
- No breaking changes to public API
- MySQL remains the default when database type is not specified

## Benefits of PostgreSQL Support

1. **Enterprise Adoption**: PostgreSQL is widely used in enterprise environments
2. **Advanced Features**: Better support for JSON, arrays, and advanced data types
3. **Standards Compliance**: More SQL standard compliant than MySQL
4. **Performance**: Often better performance for complex queries
5. **Extensibility**: Rich ecosystem of extensions and functions

## Conclusion

Adding PostgreSQL support to SQL-SOAR requires systematic changes across multiple components but maintains the library's core philosophy of simplicity and developer control. The modular architecture makes this extension feasible while preserving backward compatibility with existing MySQL deployments.